<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KMB Real-Time ETA</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="header-controls">
        <h1>KMB Real-Time Bus ETA</h1>
        <div class="theme-switch-wrapper">
          <label class="theme-switch" for="darkModeToggle">
            <input type="checkbox" id="darkModeToggle" />
            <span class="slider round"></span>
          </label>
          <span class="theme-label">Dark Mode</span>
        </div>
      </div>

      <div class="controls">
        <div>
          <label for="stop-name-input">Bus Stop Name (EN/CN):</label>
          <input
            type="text"
            id="stop-name-input"
            placeholder="e.g., Tsim Sha Tsui or 尖沙咀"
          />
        </div>
        <div>
          <label for="route-filter-input">Filter Routes (optional):</label>
          <input
            type="text"
            id="route-filter-input"
            placeholder="e.g., 1A,271"
          />
        </div>
        <div class="grouping-control">
          <input type="checkbox" id="smart-grouping-checkbox" />
          <label for="smart-grouping-checkbox">Smart Grouping</label>
        </div>
        <button id="search-button">Search ETAs</button>
      </div>

      <div id="status-messages"></div>
      <div id="stop-selection-area"></div>
      <div id="eta-results-area"></div>
      <div id="legend">
        <p><strong>Legend:</strong></p>
        <p><span class="scheduled-eta">Grey Text / Italic</span>: Scheduled Bus</p>
        <p>
          <span>*, !, ^</span>: See "Remarks" column for details.
        </p>
        <p>Route colors indicate service type (e.g., Overnight, Airport).</p>
      </div>
    </div>

    <script>
      // --- PASTE THE ENTIRE JAVASCRIPT FROM THE PREVIOUS CORRECTED `index.html` HERE ---
      // (Including API_BASE_URL, caching, fetchData, getStopList, getStopEta,
      //  name processing, status functions, getRouteColorClass, formatEtaTime,
      //  formatRouteNumberForDisplay, parseRouteForSorting, renderEtaTable, handleSearch)
      //
      // The only functions that need modification are handleUrlParameters and DOMContentLoaded.
      // -----------------------------------------------------------------------
      const API_BASE_URL = "https://data.etabus.gov.hk/v1/transport/kmb";
      const STOP_CACHE_KEY = "kmb_stop_data_cache";
      const ROUTE_CACHE_KEY = "kmb_route_data_cache";
      const CACHE_EXPIRY_HOURS = 23;

      const OVERRIDE_WORDS = new Set([
        "KMB", "LWB", "MTR", "BBI", "PTI", "McDonald's", "HSBC",
        "NT", "KLN", "HK", "Rd", "St", "Ave", "FEHD", "LCSD",
        "(N)", "(S)", "(E)", "(W)", "I", "II", "III", "IV", "V"
      ]);

      const stopNameInput = document.getElementById("stop-name-input");
      const routeFilterInput = document.getElementById("route-filter-input");
      const smartGroupingCheckbox = document.getElementById("smart-grouping-checkbox");
      const searchButton = document.getElementById("search-button");
      const statusMessagesDiv = document.getElementById("status-messages");
      const stopSelectionAreaDiv = document.getElementById("stop-selection-area");
      const etaResultsAreaDiv = document.getElementById("eta-results-area");
      const darkModeToggle = document.getElementById('darkModeToggle');
      
      let stopNameCache = {};

      function saveToCache(key, data) { /* ... same ... */ }
      function loadFromCache(key) { /* ... same ... */ }
      function isCacheValid(cacheEntry, expiryHours = CACHE_EXPIRY_HOURS) { /* ... same ... */ }
      async function fetchData(url) { /* ... same ... */ }
      async function getStopList() { /* ... same ... */ }
      async function getStopEta(stopId) { /* ... same ... */ }
      function customTitleCase(str) { /* ... same ... */ }
      function processName(name) { /* ... same ... */ }
      function processStopRouteEntry(entry) { /* ... same ... */ }
      function processEtaEntry(entry) { /* ... same ... */ }
      function parsePlatformFromStopName(stopNameEn) { /* ... same ... */ }
      function setStatus(message, type = "info") { /* ... same ... */ }
      function clearStatus() { /* ... same ... */ }
      function getRouteColorClass(routeStr) { /* ... same ... */ }
      function formatEtaTime(isoTimestamp) { /* ... same ... */ }
      function formatRouteNumberForDisplay(routeStr) { /* ... same ... */ }
      function parseRouteForSorting(routeStr) { /* ... same ... */ }
      function renderEtaTable(stopIdentifier, etasFromApi, isGrouped = false, platformForTitle = null) { /* ... same ... */ }
      async function handleSearch() { /* ... same ... */ }
      // --- End of previously existing functions (ensure they are all here) ---


      // MODIFIED: Function to handle URL parameters with reversed format
      function handleUrlParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q'); 

        if (query) {
            console.log("URL query parameter found:", query);
            // Expected format: "{route_numbers} @ {stop_name}"
            // Or just "{stop_name}" if no routes are specified (though less likely with this format)
            // Or just "{route_numbers}" if no stop name (less useful for this app)
            
            const parts = query.split('@').map(part => part.trim());
            let stopName = "";
            let routeNumbers = "";

            if (parts.length === 1) {
                // Assume it's a stop name if no "@"
                stopName = parts[0];
            } else if (parts.length > 1) {
                routeNumbers = parts[0]; // First part is routes
                stopName = parts[1];     // Second part is stop name
            }


            if (stopName) {
                stopNameInput.value = stopName;
                console.log("Set stop name input to:", stopName);
            }
            if (routeNumbers) {
                routeFilterInput.value = routeNumbers;
                console.log("Set route filter input to:", routeNumbers);
            }

            // Auto-trigger search only if a stopName was successfully parsed
            if (stopName) { 
                setTimeout(() => {
                    console.log("Auto-triggering search from URL parameters.");
                    searchButton.click(); 
                }, 100);
                return true; 
            }
        }
        return false; 
      }


      searchButton.addEventListener("click", handleSearch);
      stopNameInput.addEventListener("keypress", (event) => { if (event.key === "Enter") handleSearch(); });
      routeFilterInput.addEventListener("keypress", (event) => { if (event.key === "Enter") handleSearch(); });

      function setDarkMode(isDark) {
        if (isDark) { document.body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); }
        else { document.body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); }
        darkModeToggle.checked = isDark;
      }
      darkModeToggle.addEventListener('change', (event) => { setDarkMode(event.target.checked); });
      
      document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) { setDarkMode(savedTheme === 'dark'); }
        else { const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; setDarkMode(prefersDark); }
        
        const autoSearched = handleUrlParameters(); 
        if (!autoSearched) {
            setStatus("Enter a stop name to begin.", "info");
        }
      });
    </script>

    <footer>
      <p>Made by Timothy</p>
    </footer>
  </body>
</html>
